name: Setup Dependencies

# This is a reusable workflow that can be called from other workflows
# to avoid repeating dependency installation steps for each Copilot task
on:
  workflow_call:

jobs:
  copilot-setup-steps:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      AGDA_STDLIB_VERSION: v1.7.3

    steps:
      - uses: actions/checkout@v3

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      # Cache 1: Cargo Registry
      # Contains downloaded crate metadata from crates.io
      # Invalidated when: Cargo.toml changes (new dependencies or version updates)
      # Restore keys: Falls back to any previous cargo registry cache if exact match not found
      - name: Cache cargo registry
        uses: actions/cache@v3
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      # Cache 2: Cargo Index
      # Contains the index of available crates from crates.io
      # Invalidated when: Cargo.toml changes (new dependencies or version updates)
      # Restore keys: Falls back to any previous cargo index cache if exact match not found
      - name: Cache cargo index
        uses: actions/cache@v3
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-git-

      # Cache 3: Cargo Build Output
      # Contains compiled Rust artifacts (dependencies and project code)
      # Invalidated when: Cargo.toml changes (new dependencies or version updates)
      # Restore keys: Falls back to any previous build cache if exact match not found
      # Note: Source code changes don't invalidate cache; incremental compilation reuses artifacts
      - name: Cache cargo build
        uses: actions/cache@v3
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-build-

      # Cache 4: Agda Standard Library
      # Contains the cloned agda-stdlib repository (v1.7.3)
      # Invalidated when: AGDA_STDLIB_VERSION environment variable changes
      # No restore keys: Exact version match required for compatibility
      - name: Cache Agda Standard Library
        uses: actions/cache@v3
        with:
          path: ~/.agda-stdlib
          key: ${{ runner.os }}-agda-stdlib-${{ env.AGDA_STDLIB_VERSION }}

      # Cache 5: GHC Installation
      # Contains the GHC 8.10.7 compiler installed via ghcup
      # Invalidated when: GHC version changes (hardcoded to 8.10.7)
      # No restore keys: Exact version match required for compilation compatibility
      - name: Cache GHC
        uses: actions/cache@v3
        with:
          path: ~/.ghcup
          key: ${{ runner.os }}-ghcup-ghc-8.10.7

      # Cache 6: Compiled Agda Artifacts
      # Contains compiled Agda interface files (.agdai) from the standard library
      # These are generated when Agda compiles code that uses the standard library
      # Caching these significantly speeds up subsequent compilations (saves 2-5 minutes)
      # Invalidated when: AGDA_STDLIB_VERSION changes (different stdlib version)
      # No restore keys: Exact version match required for compatibility
      - name: Cache Compiled Agda Artifacts
        uses: actions/cache@v3
        with:
          path: ~/.agda
          key: ${{ runner.os }}-agda-compiled-${{ env.AGDA_STDLIB_VERSION }}

      # Cache 7: APT Package Cache
      # Contains downloaded .deb packages to speed up apt-get install
      # Caching the APT archives avoids re-downloading Agda and its dependencies
      # Invalidated when: Ubuntu version changes (runner.os includes Ubuntu version)
      - name: Cache APT packages
        uses: actions/cache@v3
        with:
          path: |
            /var/cache/apt/archives
            /var/lib/apt/lists
          key: ${{ runner.os }}-apt-agda-2.6.3

      - name: Install Agda
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y agda

          # Verify Agda installation
          echo "Agda installed:"
          agda --version

      - name: Install GHC
        run: |
          set -e
          # Set ghcup to install in user directory so caching works
          export GHCUP_INSTALL_BASE_PREFIX="$HOME"
          
          # Add ghcup and GHC to PATH if cached
          export PATH="$HOME/.ghcup/bin:$PATH"

          # Install GHC 8.10.7 via ghcup (compatible with Agda 2.6.3)
          # The default GHC 9.4.7 has deprecated '*' at type-level which causes compilation errors
          if ! ghc --version 2>/dev/null | grep -q "8.10.7"; then
            echo "Installing GHC 8.10.7 via ghcup..."
            ghcup install ghc 8.10.7
            ghcup set ghc 8.10.7
          else
            echo "GHC 8.10.7 already installed (cached)"
          fi

          # Verify GHC installation
          echo "GHC installed:"
          ghc --version

      - name: Install Agda Standard Library
        run: |
          set -e
          # Agda 2.6.3 is compatible with agda-stdlib v1.7.3

          # Clone agda-stdlib from GitHub if not cached
          if [ ! -d ~/.agda-stdlib ] || [ -z "$(ls -A ~/.agda-stdlib 2>/dev/null)" ]; then
            rm -rf ~/.agda-stdlib
            git clone --branch $AGDA_STDLIB_VERSION --depth 1 https://github.com/agda/agda-stdlib.git ~/.agda-stdlib
          fi

          # Register the library with Agda
          mkdir -p ~/.agda
          AGDA_LIB_PATH="$HOME/.agda-stdlib/standard-library.agda-lib"
          # Only add if not already present
          grep -qxF "$AGDA_LIB_PATH" ~/.agda/libraries 2>/dev/null || echo "$AGDA_LIB_PATH" >> ~/.agda/libraries
          grep -qxF "standard-library" ~/.agda/defaults 2>/dev/null || echo "standard-library" >> ~/.agda/defaults

          # Verify installation
          echo "Installed agda-stdlib version: $AGDA_STDLIB_VERSION"
          ls -la ~/.agda-stdlib/standard-library.agda-lib

