# Copilot Instructions for Proving Philosophers

## Repository Overview

This is a **Rust + Agda** project that demonstrates the dining philosophers problem. The project is small (~10 files) and uses:
- **Rust** (edition 2021) for the actual implementation
- **Agda** (2.6.3) for proof assistance (aspirational - not yet implemented)
- **GHC** (Haskell compiler) to compile Agda code
- **Makefile** for build automation

**IMPORTANT: Despite what the README says, the Agda code does NOT yet generate Rust code. When making changes to the Rust code, there is NO need to update the Agda code.**

## Build and Test Commands

**ALWAYS use the Makefile commands** for building and testing. The project has specific requirements that are handled correctly by these commands:

### Quick Commands
```bash
# Run all tests (both Agda and Rust) - This is the main validation
make all

# Test Agda code generation (verifies generated code matches expected)
# NOTE: Currently this just tests a "Hello, world!" placeholder
make test-agda

# Clean intermediate files
make clean

# Clean all generated files
make clobber
```

### Individual Build Steps
```bash
# Build Agda executable (takes 2-5 minutes)
make build-agda

# Run Agda executable (currently outputs "Hello, world!")
make run-agda

# Build Rust code
make build-rust

# Run the dining philosophers
make run-rust
```

### Important Build Notes
- **GHC Version Requirement**: MUST use GHC 9.0 or earlier. GHC 9.2+ is incompatible with Agda-generated code. **Recommended: GHC 8.10.7** (tested in CI).
- **Agda Standard Library**: Requires agda-stdlib v1.7.3 (must match Agda 2.6.3)
- **Build Times**: Building Agda from scratch takes 2-5 minutes on first run; subsequent runs are faster
- **Test Validation**: `make test-agda` compares `generated.rs` with `rust/expected.rs` using `diff -u`
- **Agda Status**: The Agda code currently only outputs "Hello, world!" - it does NOT yet generate the Rust code

## Project Structure

```
.
├── .github/
│   ├── workflows/test.yml       # CI pipeline with 5 caching strategies
│   └── CI_CACHING.md            # Detailed caching documentation
├── agda/
│   └── Main.agda                # Main Agda file (currently outputs "Hello, world!")
├── agda-build/                  # Compiled Agda executable (generated)
│   └── Main
├── rust/
│   ├── main.rs                  # Rust implementation (dining philosophers)
│   └── expected.rs              # Expected generated code (for testing)
├── generated.rs                 # Rust code generated by Agda (temporary)
├── Cargo.toml                   # Rust config (binary in rust/main.rs)
└── Makefile                     # Build automation
```

### Key Files to Modify
- **Rust code**: `rust/main.rs` (the actual implementation)
- **Expected output**: `rust/expected.rs` (must match generated code in tests)
- **Agda main**: `agda/Main.agda` (currently a placeholder)

### Configuration Files
- `Cargo.toml`: Rust package config (binary path is `rust/main.rs`)
- `.github/workflows/test.yml`: CI pipeline
- `.cargo/config.toml`: Sets custom target directory to `rust-build`

## CI/CD Workflow

The GitHub Actions workflow (`.github/workflows/test.yml`) runs on push and PR to `main`:
1. Installs Rust (latest stable)
2. Installs Agda 2.6.3 and GHC 8.10.7 via ghcup
3. Installs agda-stdlib v1.7.3
4. Runs `make all` (tests both Agda and Rust)

## Validation Steps

Before committing changes:

1. **Clean build**: Run `make clean` then `make all` to verify from scratch
2. **Agda test**: Ensure `make test-agda` passes (generated code matches expected)
3. **Build Rust**: Ensure `make build-rust` passes
4. **When modifying Rust code**: Changes to `rust/main.rs` do NOT require updating Agda code, since code generation is not yet implemented. Just ensure the Rust code compiles.

## Common Patterns

### Dining Philosophers Solution
Uses **ordered resource hierarchy**:
- 5 forks numbered 0-4
- Philosophers always pick up the lower-numbered fork first (except the last philosopher)
- This ordering prevents circular wait conditions and deadlock

## Dependencies

- Rust: edition 2021 or later
- Agda: 2.6.3 (installed via apt-get on Ubuntu)
- agda-stdlib: v1.7.3 (cloned from GitHub)
- GHC: 8.10.7 (installed via ghcup, NOT the default 9.4.7)
- Standard Unix tools: make, diff, git

## Important Notes

- **Trust these instructions**: Only search for additional information if instructions are incomplete or incorrect
- **Use Makefile**: Don't run `agda` or `cargo` commands directly unless necessary
- **GHC version is critical**: The project will NOT compile with GHC 9.2+ (use GHC 9.0 or earlier)
- **Generated files**: `agda-build/` and `generated.rs` are generated and should not be manually edited
- **Test file**: `rust/expected.rs` must be kept in sync with `rust/main.rs` logic
