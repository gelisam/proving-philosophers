# Proving Philosophers

A Rust + Agda project demonstrating the dining philosophers problem with code generation from an abstract syntax tree.

## Overview

This project implements the dining philosophers problem where:
- **Rust code** (`rust/main.rs`): Implements the solution using ordered forks to prevent deadlock
- **Agda code** (`agda/DiningPhilosophers.agda`): Defines an abstract syntax tree (AST) for simplified Rust operations and compiles to an executable that generates the exact Rust code

## Key Concepts

The Agda AST simplifies common Rust patterns into single operations:
- `Lock` → `.lock().unwrap()`
- `Sleep` → `thread::sleep(std::time::Duration::from_millis(100))`

This abstraction allows for easier reasoning about the algorithm while maintaining the ability to generate correct, idiomatic Rust code.

## Dining Philosophers Solution

The implementation uses the **ordered resource hierarchy** solution:
1. Five forks are numbered 0-4
2. Each philosopher sits between two forks
3. Philosophers always pick up the lower-numbered fork first, except the last philosopher
4. This ordering prevents circular wait conditions and thus prevents deadlock

## Project Structure

```
.
├── rust/
│   ├── main.rs                  # Rust implementation of dining philosophers
│   └── expected.rs              # Expected Rust code for testing
├── agda/
│   ├── DiningPhilosophers.agda  # Agda AST definition and code generator
│   └── Main.agda                # Main Agda file that compiles to executable
├── agda-build/                  # Compiled Agda executable (generated)
│   └── Main
├── generated.rs                 # Rust code generated by Agda (generated)
├── test_generation.sh           # Test that generated code matches actual code
├── Cargo.toml                   # Rust project configuration
├── Makefile                     # Build automation
└── README.md                    # This file
```

## Building and Running

### Quick Start

The project includes a Makefile for convenience:

```bash
# Run all tests (both Agda and Rust)
make all

# Test Agda code generation
make test-agda

# Test Rust code
make test-rust

# Build the Agda executable
make build-agda

# Run the Agda executable (generates Rust code)
make run-agda

# Build the Rust code
make build-rust

# Run the dining philosophers
make run-rust

# Clean intermediate files
make clean

# Clean all generated files
make clobber
```

### Rust Code

```bash
# Build the Rust code
cargo build

# Run the dining philosophers
cargo run

# Run tests
cargo test
```

### Agda Code

To compile the Agda code generator:

```bash
mkdir -p agda-build
agda \
  --compile \
  --library standard-library \
  --include-path agda \
  --compile-dir=agda-build \
  agda/Main.agda
```

This will create the `agda-build/Main` executable. To generate Rust code:

```bash
./agda-build/Main > generated.rs
```

### Testing Code Generation

```bash
# Test that the Agda generator produces exactly the expected Rust code
make test-agda
```

This will:
1. Build the Agda executable if needed
2. Run the executable to generate Rust code to `generated.rs`
3. Compare it with the expected output in `rust/expected.rs`
4. Report success if they match exactly

## AST Examples

The following AST nodes demonstrate the simplification:

```agda
-- Lock operation: expands to .lock().unwrap()
Lock "first_fork" "_guard1"
  generates: let _guard1 = first_fork.lock().unwrap();

-- Sleep operation: expands to thread::sleep with Duration
Sleep 100
  generates: thread::sleep(std::time::Duration::from_millis(100));
```

## Requirements

- Rust (edition 2021 or later)
- Agda 2.6.3 or later (with standard library v1.7.3)
- GHC (Haskell compiler, required for compiling Agda code)
  - **Required: GHC 9.0 or earlier** (GHC 9.2+ is not compatible with Agda-generated Haskell code)
  - **Recommended: GHC 8.10.7** (tested in CI)

## Continuous Integration

This project uses GitHub Actions for continuous integration. The CI workflow:
- Runs all tests (both Agda and Rust)
- Uses multiple caches to speed up builds
- Installs compatible versions of Agda, agda-stdlib, and GHC

For details about the caching strategy and how to optimize CI performance, see [.github/CI_CACHING.md](.github/CI_CACHING.md).

## Testing

The project includes tests for both Agda code generation and Rust code:

```bash
# Run all tests
make all

# Run just Agda tests (verifies code generation)
make test-agda

# Run just Rust tests
make test-rust
```

The Agda test ensures that running the Agda-compiled executable outputs exactly the expected Rust code in `rust/expected.rs`.